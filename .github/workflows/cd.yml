# GitHub Actions - Deploy Contínuo (CD)
# Deploy para Google Cloud Run quando há push na branch main

name: CD Pipeline

# Desabilitado temporariamente até configurar secrets do GCP
# Para habilitar: remova o comentário das linhas 'on:' abaixo
on:
  # push:
  #   branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  BACKEND_SERVICE: medvision-backend
  FRONTEND_SERVICE: medvision-frontend

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Autenticar no Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configurar Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configurar Docker para GCR
        run: gcloud auth configure-docker

      - name: Build e Push Backend
        env:
          IMAGE: gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }}
        run: |
          docker build -t $IMAGE ./backend
          docker push $IMAGE

      - name: Deploy Backend no Cloud Run
        run: |
          gcloud run deploy ${{ env.BACKEND_SERVICE }} \
            --image gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --memory 4Gi \
            --cpu 2 \
            --timeout 300 \
            --max-instances 10 \
            --set-env-vars ENVIRONMENT=production,LOG_LEVEL=INFO \
            --set-secrets GEMINI_API_KEY=gemini-api-key:latest,AWS_ACCESS_KEY_ID=aws-access-key:latest,AWS_SECRET_ACCESS_KEY=aws-secret-key:latest

      - name: Build e Push Frontend
        env:
          IMAGE: gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_SERVICE }}:${{ github.sha }}
        run: |
          docker build -t $IMAGE ./frontend
          docker push $IMAGE

      - name: Deploy Frontend no Cloud Run
        run: |
          gcloud run deploy ${{ env.FRONTEND_SERVICE }} \
            --image gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_SERVICE }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --port 80

      - name: Obter URLs de serviço
        id: service-urls
        run: |
          BACKEND_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} --region ${{ env.REGION }} --format 'value(status.url)')
          FRONTEND_URL=$(gcloud run services describe ${{ env.FRONTEND_SERVICE }} --region ${{ env.REGION }} --format 'value(status.url)')
          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT

      - name: Notificar deploy bem-sucedido
        run: |
          echo "✅ Deploy concluído com sucesso!"
          echo "Backend: ${{ steps.service-urls.outputs.backend_url }}"
          echo "Frontend: ${{ steps.service-urls.outputs.frontend_url }}"

  # Job de rollback em caso de falha
  rollback:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
      - name: Autenticar no Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configurar Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Rollback para versão anterior
        run: |
          echo "❌ Deploy falhou. Executando rollback..."
          gcloud run services update-traffic ${{ env.BACKEND_SERVICE }} \
            --to-revisions LATEST=100 \
            --region ${{ env.REGION }}
          gcloud run services update-traffic ${{ env.FRONTEND_SERVICE }} \
            --to-revisions LATEST=100 \
            --region ${{ env.REGION }}
